/*! *****************************************************************************
  pfadi-lieder-kiosk
  Version 2.0.0
  A webapp that provides song texts for scout groups.
  (c) Jan Litzenburger
  Licence: MIT
  This file is auto-generated. Do not edit.
***************************************************************************** */
"use strict";var t=require("path"),e=require("cheerio"),r=require("fs"),n=require("util");function i(t){return t&&"object"==typeof t&&"default"in t?t:{default:t}}function o(t){if(t&&t.__esModule)return t;var e=Object.create(null);return t&&Object.keys(t).forEach((function(r){if("default"!==r){var n=Object.getOwnPropertyDescriptor(t,r);Object.defineProperty(e,r,n.get?n:{enumerable:!0,get:function(){return t[r]}})}})),e.default=t,Object.freeze(e)}var s=o(t),a=i(e),c=o(r);
/*! *****************************************************************************
Copyright (c) Microsoft Corporation.

Permission to use, copy, modify, and/or distribute this software for any
purpose with or without fee is hereby granted.

THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS SOFTWARE.
***************************************************************************** */
function l(t,e,r,n){return new(r||(r=Promise))((function(i,o){function s(t){try{c(n.next(t))}catch(t){o(t)}}function a(t){try{c(n.throw(t))}catch(t){o(t)}}function c(t){var e;t.done?i(t.value):(e=t.value,e instanceof r?e:new r((function(t){t(e)}))).then(s,a)}c((n=n.apply(t,e||[])).next())}))}
/*!
 * express
 * Copyright(c) 2009-2013 TJ Holowaychuk
 * Copyright(c) 2013 Roman Shtylman
 * Copyright(c) 2014-2015 Douglas Christopher Wilson
 * MIT Licensed
 */module.exports=require("./lib/express");var u=Object.freeze({__proto__:null}),p=require("url"),d=require("graceful-fs"),h=require("tmp"),f=require("stream"),g=require("cross-spawn"),m=require("./options");require("concat-stream");var S=__dirname+"/webshot.phantom.js",y=["jpeg","jpg","png","pdf"],x=["url","html","file"];function v(t,e){t.windowSize=t.windowSize||t.screenSize,t.userAgent&&(t.settings=t.settings||{},t.settings.userAgent=t.userAgent),t.script&&(t.onLoadFinished=t.onLoadFinished||t.script);var r=m.mergeObjects(t,e);return m.phantomCallback.forEach((function(t){var e=r[t];e&&("[object Function]"===toString.call(e)?r[t]={fn:e.toString(),context:{}}:e.fn=e.fn.toString())})),r}function b(t,e,r,n,i){var o=m.filterObject(n,Object.keys(m.phantom).concat(m.phantomPage).concat(m.phantomCallback));o.site=t,o.path=e,o.streaming=r;var s=[S,JSON.stringify(o)];n.phantomConfig&&(s=Object.keys(n.phantomConfig).map((function(t){return"--"+t+"="+n.phantomConfig[t]})).concat(s));var a=g.spawn(n.phantomPath,s),c=null,l=!1;if(n.timeout&&(c=setTimeout((function(){if(!l){l=!0,a.kill("SIGKILL");var t=new Error("PhantomJS did not respond within the given timeout setting.");if(i)return i(t);u.emit("error",t)}}),n.timeout)),r){var u=new f.Stream;u.readable=!0;var p=!1,d=!1,h=[];a.stdout.on("data",(function(t){clearTimeout(c),i&&!d?h.push(new Buffer(""+t,"base64")):u.emit("data",new Buffer(""+t,"base64"))}));var y=function(t){i?(d=!0,i(t)):(p=!0,u.emit("error",t))},x=[];return a.stderr.on("data",(function(t){x.push(t)})),a.stderr.on("end",(function(t){var e=x.shift();if(e){var r=e.toString().trim();if(r){var i;try{var o=JSON.parse(r);(i=new Error(o.msg)).isNon200Error=o.isNon200Error,i.isJsError=o.isJsError}catch(t){return(i=new Error(r)).unknownError=!0,y(i)}return n.errorIfStatusIsNot200&&i.isNon200Error||n.errorIfJSException&&i.isJsError?y(i):void 0}}})),a.on("exit",(function(){i&&!d&&(i(null,u),u.emit("data",Buffer.concat(h))),p||u.emit("end")})),u}a.stderr.on("data",(function(t){if(n.errorIfJSException){var e=JSON.parse(t.toString());l=!0,clearTimeout(c),i(new Error(e.msg))}})),a.on("exit",(function(t){l||(l=!0,clearTimeout(c),i(t?new Error("PhantomJS exited with return value "+t):null))}))}module.exports=function(){var t=Array.prototype.slice.call(arguments,0),e=null,r={},n=null,i=t.shift(),o=t[t.length-1];switch("[object Function]"==Object.prototype.toString.call(o)&&(e=t.pop()),t.length){case 1:var s=t.pop();"[object String]"===toString.call(s)?n=s:r=s;break;case 2:n=t.shift(),r=t.shift()}var a=!n,c=m.mergeObjects(m.caller,m.phantom);try{c.phantomPath=require("phantomjs-prebuilt").path}catch(t){}r=v(r,c);var l=n?n.substring(1+~(~n.lastIndexOf(".")||~n.length)):r.streamType;if(!~y.indexOf(l.toLowerCase()))return e(new Error("All files must end with one of the following extensions: "+y.join(", ")));if(!~x.indexOf(r.siteType)){var u=new Error(t.siteType+" is not a valid sitetype.");if(e)return e(u);throw u}"url"===r.siteType&&(i=p.parse(i).protocol?i:"http://"+i);var f=function(){if("html"===r.siteType){var t=h.fileSync(),o=t.name;return d.writeSync(t.fd,i,null,"utf-8"),d.close(t.fd),r.siteType="file",i=o,f()}return b(i,n,a,r,e)};if(!n)return f();d.exists(n,(function(t){if(!t)return f();d.unlink(n,(function(t){return t?e(t):f()}))}))};var w=Object.freeze({__proto__:null});const O=n.promisify(w);class T{constructor(){this.tempFile="/tmp/printFile.png",this.template=c.readFileSync("dist/app/templates/SongPrint.html","utf8"),this.options={screenSize:{width:"384",height:"1"},shotSize:{width:"384",height:"all"},siteType:"html",defaultWhiteBackground:!0},this.generateSongtext=t=>l(this,void 0,void 0,(function*(){try{const e=a.default.load(this.template);return e("#songText").html(t.text),e("h2").html(t.title),t.hasChords&&e("#songText").addClass("chordline"),yield O(e.html(),this.tempFile,this.options),Promise.resolve("OK")}catch(t){return Promise.reject(t)}}))}}class j{constructor(){this.formatter=new T,this.printSong=t=>l(this,void 0,void 0,(function*(){yield this.formatter.generateSongtext(t)}))}}(function(){var t,e,r,n,i={}.hasOwnProperty;e=require("./defaults"),t=require("./builder"),r=require("./parser"),n=require("./processors"),exports.defaults=e.defaults,exports.processors=n,exports.ValidationError=function(t){function e(t){this.message=t}return function(t,e){for(var r in e)i.call(e,r)&&(t[r]=e[r]);function n(){this.constructor=t}n.prototype=e.prototype,t.prototype=new n,t.__super__=e.prototype}(e,Error),e}(),exports.Builder=t.Builder,exports.Parser=r.Parser,exports.parseString=r.parseString,exports.parseStringPromise=r.parseStringPromise}).call(void 0);class L{constructor(t){this.title=t.title,this.hasChords=t.text.indexOf("{")>=0,this.text=t.text.replace(/\n\s*\n\s*/gm,"<br><br>").replace(/\n\s*/gm,"<br>").replace(/\{(\w*?)\}([^\{\<]*)/gi,"<span><strong><span>[</span>$1<span>]</span></strong>$2</span>"),this.category=t.category}}class C{constructor(t,e,r){this.id=t,this.title=e,this.category=r}}const E=new(void 0);class q{constructor(){this.parseSongsLib=()=>{const t=c.readFileSync("dist/data/songs.xml","utf8");let e=null;E.parseString(t,{explicitArray:!1,explicitRoot:!1,trim:!0},((t,r)=>{e=r}));const r=[];return e.song.forEach((t=>{r.push(new L(t))})),r},this.findSongByString=(t,e)=>{const r=t.toLocaleLowerCase(),n=[];return this.songLib.forEach((i=>{if(i.hasChords||!e.chordsOnly)if(e.includeTitle&&i.title.toLocaleLowerCase().indexOf(r)>=0){const t=new C(this.songLib.indexOf(i),i.title,i.category);if(t.hasChords=i.text.indexOf("<span>")>=0,e.addTextSnipped){const e=this.normalizeText(i.text);t.textSnipped=this.getTextSnipped(e)}n.push(t)}else if(e.includeText&&i.text.toLocaleLowerCase().indexOf(r)>=0){const r=new C(this.songLib.indexOf(i),i.title,i.category);r.hasChords=i.text.indexOf("<span>")>=0;const o=this.normalizeText(i.text),s=o.toLocaleLowerCase().indexOf(t);r.phrase=o.substring(s-10,s+20).trim(),e.addTextSnipped&&(r.textSnipped=this.getTextSnipped(o)),n.push(r)}})),n.sort(this.alphabeticTitleComparator),n},this.alphabeticTitleComparator=(t,e)=>t.title<e.title?-1:t.title>e.title?1:0,this.getTextSnipped=t=>{let e="";const r=t.split(". ");let n=2;for(const t of r)if(e+=`${t}. `,n-=n-1,0===n)break;return e},this.normalizeText=t=>t.replace(/<br\s*\/?>/gi," ").replace(/\{\w*\}/gi,"").replace(/<\/?\w*>/gi,"").replace(/\[\w*\]/gi,""),this.songLib=this.parseSongsLib()}getSongById(t){return this.songLib[t]}getTotalSongNumber(){return this.songLib.length}}(new class{constructor(){this.PORT=8080,this.songsLib=new q,this.printerService=new j}startServer(){const t=u();t.use("/",(void 0)(s.resolve("/../static_html"))),t.get("/song/:songId",((t,e)=>l(this,void 0,void 0,(function*(){e.setHeader("Content-Type","application/json"),e.send(JSON.stringify(this.songsLib.getSongById(t.params.songId)))})))),t.get("/print/:songId",((t,e)=>l(this,void 0,void 0,(function*(){e.setHeader("Content-Type","application/json");try{const r=this.songsLib.getSongById(t.params.songId);yield this.printerService.printSong(r),e.send(JSON.stringify({status:"OK"}))}catch(t){e.send(JSON.stringify({status:"failed",error:t}))}})))),t.get("/search/:term",((t,e)=>l(this,void 0,void 0,(function*(){e.setHeader("Content-Type","application/json");e.send(JSON.stringify(this.songsLib.findSongByString(t.params.term,{includeTitle:!0,includeText:!0,chordsOnly:!1,addTextSnipped:!0})))})))),t.get("/fullSearch/:term",((t,e)=>l(this,void 0,void 0,(function*(){e.setHeader("Content-Type","application/json");const r={includeTitle:"true"===t.query.includeTitle,includeText:"true"===t.query.includeText,chordsOnly:"true"===t.query.chordsOnly,addTextSnipped:!0};e.send(JSON.stringify(this.songsLib.findSongByString(t.params.term,r)))})))),t.get("/getTotalSongsNumber",((t,e)=>l(this,void 0,void 0,(function*(){e.setHeader("Content-Type","application/json"),e.send(JSON.stringify({songs:this.songsLib.getTotalSongNumber()}))})))),t.listen(this.PORT,(()=>{console.log(`Rest Endpoint Server started listening on port ${this.PORT}`)}))}}).startServer();
